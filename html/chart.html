<!DOCTYPE html>
<html>
<head>
  <title>Google Analytics Chart</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- <script src="../javascript/auth.js"></script> -->
  <!-- <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>  -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- <script src="https://accounts.google.com/gsi/client"></script> -->
</head> 
<body>
  <!-- Gumbi za autentifikaciju -->
  <!-- <button id="signin-button" onclick="handleAuthClick()">Prijavi se</button>
  <button id="signout-button" onclick="handleSignoutClick()">Odjavi se</button> -->

  <button onclick="handleAuthClick()" disabled>Prijavite se s Google računom</button>

  <!-- Tipka za odjavu -->
  <button onclick="handleSignoutClick()" style="display:none;">Odjavite se</button>

  <!-- Platno za Chart.js grafikon -->
  <canvas id="chart" style="display:none;" width="400" height="200"></canvas>

  <script>
    const CLIENT_ID = '214036241518-be5frrk0bus3h05oo3dt6b2t1j19onr3.apps.googleusercontent.com';
const API_KEY = 'AIzaSyAJugTkVuqv5BbYEPm9rr7U4mPSA5fvdmI';
const DISCOVERY_DOCS = [
  'https://www.googleapis.com/discovery/v1/apis/analytics/v3/rest'
];
const SCOPES = 'https://www.googleapis.com/auth/analytics.readonly';
const REDIRECT_URI = 'https://eportfoliomatijasic.netlify.app/html/chart.html';

let isAuthenticated = false;
let tokenClient;

// Funkcija koja se poziva kad je korisnik autentificiran
function handleCredentialResponse(response) {
  const credential = response.credential;
  const token = google.accounts.oauth2.idToken; // Ovdje uzimamo ID token

  if (token) {
    localStorage.setItem("access_token", token);
    isAuthenticated = true;
    document.getElementById('chart').style.display = 'block';
    fetchAnalyticsData();
  } else {
    console.error("Nema tokena.");
  }
}

// Funkcija za pokretanje autentifikacije
function handleAuthClick() {
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse,
  });
  google.accounts.id.prompt();
}

// Funkcija za odjavu korisnika
function handleSignoutClick() {
  google.accounts.oauth2.revoke(localStorage.getItem("access_token"), () => {
    isAuthenticated = false;
    document.getElementById('chart').style.display = 'none';
    console.log("User signed out.");
  });
  localStorage.removeItem("access_token");
}

// Dohvaćanje podataka iz Google Analytics API-a
async function fetchAnalyticsData() {
  const token = localStorage.getItem("access_token");
  if (!token) {
    console.error("Nema pristupnog tokena. Prijavite se ponovno.");
    return;
  }

  try {
    const response = await fetch(`https://analytics.googleapis.com/v3/data/ga?ids=ga%3A443269906&start-date=30daysAgo&end-date=today&metrics=ga%3AactiveUsers,ga%Asessions,ga%AaverageSessionDuration`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });

    const data = await response.json();
    renderChart(data);
  } catch (err) {
    console.error("Greška u dohvaćanju podataka:", err);
  }
}

// Funkcija za renderiranje grafikona
function renderChart(data) {
  const labels = data.rows.map(row => row[0]);  // Prilagodite prema stvarnim podacima
  const chartData = {
    labels: labels,
    datasets: [{
      label: 'Active Users',
      data: data.rows.map(row => row[1]),
      backgroundColor: 'rgba(75, 192, 192, 0.2)',
      borderColor: 'rgba(75, 192, 192, 1)',
      borderWidth: 1,
    }],
  };

  const ctx = document.getElementById('chart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: chartData,
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Google Analytics Data' },
      },
    },
  });
}

// Inicijalizirajte Google Identity Services
window.onload = function() {
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse,
  });
  document.querySelector('button[onclick="handleAuthClick()"]').disabled = false;  // Omogućite gumb za prijavu
};
  </script>

</body>
</html>