<!DOCTYPE html>
<html>
<head>
  <title>Google Analytics Chart</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- <script src="../javascript/auth.js"></script> -->
  <!-- <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>  -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- <script src="https://accounts.google.com/gsi/client"></script> -->
</head> 
<body>
  <!-- Gumbi za autentifikaciju -->
  <!-- <button id="signin-button" onclick="handleAuthClick()">Prijavi se</button>
  <button id="signout-button" onclick="handleSignoutClick()">Odjavi se</button> -->

  <button onclick="handleAuthClick()" disabled>Prijavite se s Google računom</button>

  <!-- Tipka za odjavu -->
  <button onclick="handleSignoutClick()" style="display:none;">Odjavite se</button>

  <!-- Platno za Chart.js grafikon -->
  <canvas id="chart" style="display:none;" width="400" height="200"></canvas>

  <script>
    const CLIENT_ID = '214036241518-be5frrk0bus3h05oo3dt6b2t1j19onr3.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAJugTkVuqv5BbYEPm9rr7U4mPSA5fvdmI';
    const DISCOVERY_DOCS = [
      'https://www.googleapis.com/discovery/v1/apis/analytics/v3/rest'
    ];
    const SCOPES = 'https://www.googleapis.com/auth/analytics.readonly';
    const REDIRECT_URI = 'https://eportfoliomatijasic.netlify.app/html/chart.html';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let isAuthenticated = false;

    function gapiLoaded() {
      gapi.load('client', () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES,
          redirectUri: REDIRECT_URI
        }).then(() => {
          gapiInited = true;
          maybeEnableButtons();
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            redirect_uri: REDIRECT_URI,
            callback: handleTokenResponse
          });
          gisInited = true;
          maybeEnableButtons();
        }).catch((err) => {
          console.error("Greška u inicijalizaciji GAPI klijenta:", err);
        });
      });
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.querySelector('button[onclick="handleAuthClick()"]').disabled = false;
      }
    }

    function handleTokenResponse(tokenResponse) {
      console.log("Odgovor od Googlea:", tokenResponse);
      if (tokenResponse.access_token) {
        localStorage.setItem("access_token", tokenResponse.access_token);
        isAuthenticated = true;
        const chartElement = document.getElementById('chart');
        if (chartElement) {
          chartElement.style.display = 'block';
        }
        fetchAnalyticsData();
      } else {
        console.error('Nema pristupnog tokena!');
      }
    }

    function handleAuthClick() {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse
      });
      google.accounts.id.prompt();
    }

    function handleCredentialResponse(response) {
      const token = response.credential;
      console.log("Google Login Token:", token);

      localStorage.setItem("access_token", token);
      isAuthenticated = true;
      const chartElement = document.getElementById('chart');
      if (chartElement) {
        chartElement.style.display = 'block';
      }
      fetchAnalyticsData();
    }

    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token, () => {
          console.log('User signed out.');
          isAuthenticated = false;
          document.getElementById('chart').style.display = 'none';
        });
        gapi.client.setToken(null);
      }
    }

    function transformAnalyticsData(result) {
      const labels = result.rows.map(row => row.dimensionValues.map(dv => dv.value).join(' - '));
      const data = result.rows.map(row => row.metricValues[0].value);

      return {
        labels,
        datasets: [{
          label: 'Active Users',
          data,
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      };
    }

    async function fetchAnalyticsData() {
      const token = localStorage.getItem("access_token");
      if (!token) {
        console.error("Nema pristupnog tokena. Prijavite se ponovno.");
        return;
      }

      try {
        gapi.client.setToken({ access_token: token });
        const response = await gapi.client.analyticsdata.properties.runReport({
          property: "properties/443269906",
          requestBody: {
            dateRanges: [{ startDate: "30daysAgo", endDate: "today" }],
            dimensions: [{ name: "country" }, { name: "deviceCategory" }, { name: "pagePath" }],
            metrics: [{ name: "activeUsers" }, { name: "sessions" }, { name: "averageSessionDuration" }]
          }
        });
        console.log(response.result);
        const data = transformAnalyticsData(response.result);
        renderChart(data);
      } catch (err) {
        console.error("Greška u dohvaćanju analitike:", err);
      }
    }

    function renderChart(data) {
      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'bar', // Tip grafikona
        data: data,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Google Analytics Data'
            }
          }
        }
      });
    }

    window.onload = function() {
      gapiLoaded();
    };
  </script>

</body>
</html>