<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Analytics API</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://www.gstatic.com;">
</head>
<body>
    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()" style="display: none;">Sign Out</button>

    <script>
        const CLIENT_ID = '214036241518-be5frrk0bus3h05oo3dt6b2t1j19onr3.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAJugTkVuqv5BbYEPm9rr7U4mPSA5fvdmI';
        const DISCOVERY_DOCS = ["https://analyticsdata.googleapis.com/$discovery/rest?version=v1"];
        const SCOPES = "https://www.googleapis.com/auth/analytics.readonly";

        let isSignedIn = false;

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(() => {
                console.log("Google API initialized!");
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            }).catch(error => {
                console.error("Error initializing the Google API: ", error);
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'inline';
                fetchAnalyticsData();
            } else {
                document.getElementById('authorize_button').style.display = 'inline';
                document.getElementById('signout_button').style.display = 'none';
            }
        }

        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                console.log("Signed in successfully");
                updateSigninStatus(true);
            }, (error) => {
                console.error("Error signing in: ", error);
            });
        }

        function handleSignoutClick() {
            gapi.auth2.getAuthInstance().signOut().then(() => {
                updateSigninStatus(false);
            });
        }

        function fetchAnalyticsData() {
            gapi.client.analyticsdata.properties.runReport({
                property: 'properties/443269906',  // Zamijenite sa svojim property ID-jem
                requestBody: {
                    dateRanges: [{ startDate: "30daysAgo", endDate: "today" }],
                    dimensions: [{ name: "country" }, { name: "deviceCategory" }, { name: "pagePath" }],
                    metrics: [{ name: "activeUsers" }, { name: "sessions" }, { name: "averageSessionDuration" }]
                }
            }).then(response => {
                console.log(response.result); // Prikaz podataka u konzoli
            }).catch(error => {
                console.error("Error fetching data: ", error);
            });
        }

        gapi.load("client:auth2", initClient); // Uƒçitaj gapi klijent i auth2
    </script>
</body>
</html>
